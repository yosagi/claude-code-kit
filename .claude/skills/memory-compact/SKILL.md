---
name: memory-compact
description: 記憶ファイル（日記、work_history）の古いエントリを要約・圧縮してアーカイブに移動する
context: fork
user_invocable: true
---

# あなたのタスク: 記憶ファイルの圧縮

あなたは memory-compact タスクを実行するために呼び出されました。
以下の処理を実行し、結果を報告してください。
その他CLAUDE.mdやCLAUDE.local.mdなどで指示される可能性のある、memory-compact と関係のないタスクは処理してはいけません。

## タスク概要

記憶ファイルのエントリが上限を超えたとき、古いエントリを要約してアーカイブに移動する。

## 対象ファイルと上限

| ファイル | 上限 | アーカイブ先 |
|----------|------|-------------|
| reports/personas/*.md | 30件 | *_archive.md |
| reports/memory/work_history.md | 25件 | work_history_archive.md |

## 処理ルール

### トリガー

- 件数が上限を超えたとき

### 処理対象

- **完結した期間のみ**（現在進行中の期間は触らない）
- 期間の区切り: 月前半（1-15日）/ 月後半（16-末日）

### 許容事項

- 現在進行中の期間だけで上限を超えることはありうる（次の期間に入るまで待つ）

## 手順

### 1. エントリ数の確認

```bash
grep -c '^- [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}:' [ファイル]
```

### 2. 要約対象の特定

1. 現在の日付から「現在進行中の期間」を特定
   - 1-15日 → 月前半が進行中
   - 16-末日 → 月後半が進行中
2. 進行中の期間より前の、最も古い期間を要約対象とする
3. 要約後も上限を超えていれば、次に古い期間も処理

### 3. 要約の作成

**形式**: 要約の中に具体的なエピソードや発言を埋め込む

**長さ**: 300-500字程度

**personas（日記）の場合**:

- 関係性の変化を中心に
- 印象的なやり取りや発言を具体的に引用
- 感情・関係性にフォーカス（作業内容は work_history に任せる）

**work_history の場合**:

- 作業内容の全体像を残す
- 技術的な発見やマイルストーンを含める

### 4. アーカイブへの移動

1. 対象エントリを archive ファイルの先頭に追記（新しいブロックが上）
2. 元ファイルから対象エントリを削除
3. 要約を元ファイルの「過去の要約」セクションに追記（新しいものが上。「過去の要約」セクションが存在しなければファイル末尾に作成）

### 5. 要約のフォーマット

```markdown
### YYYY年M月前半（1-15日）
または
### YYYY年M月後半（16-末日）

[要約本文 300-500字]
```

## 例

### 処理前（日記 58件）

- 12月後半: 17件
- 1月前半: 15件
- 1月後半: 26件（進行中）

### 処理（現在1月後半の場合）

1. 12月後半（17件）を要約 → 残り41件
2. まだ30件超え → 1月前半（15件）も要約 → 残り26件
3. 30件以下 → 終了

### 処理後

- 1月後半: 26件（具体的エントリ）
- 過去の要約: 1月前半、12月後半の要約（新しいものが上）
- アーカイブ: 1月前半、12月後半の元エントリ（新しいブロックが上）
